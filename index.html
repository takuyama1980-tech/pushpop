<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PushPop Game</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#38bdf8">
  <style>
    body {
      margin: 0;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #a78bfa, #38bdf8);
      color: white;
    }
    header, footer {
      margin: 10px;
      text-align: center;
    }
    #board {
      display: grid;
      gap: 8px;
      margin: 20px;
    }
    .bubble {
      background: rgba(255,255,255,0.35);
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 50%;
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: transform 0.15s ease, background 0.15s ease;
    }
    .bubble.popped {
      background: rgba(255,255,255,0.18);
      transform: scale(0.9);
    }
    button, select {
      margin: 5px;
      padding: 6px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.8;
    }
    progress {
      width: 100%;
    }
    .confetti {
      position: absolute;
      width: 6px;
      height: 10px;
      opacity: 0.8;
      animation: fall 2s linear forwards;
    }
    @keyframes fall {
      to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
  </style>
</head>
<body>
  <header>
    <div id="stats">Moves: 0 | 0/0</div>
    <progress id="progress" value="0" max="1"></progress>
    <div id="bestTime"></div>
  </header>

  <main>
    <div id="board"></div>
  </main>

  <footer>
    <label>Size:
      <select id="sizeSelect">
        <option value="4">4x4</option>
        <option value="6">6x6</option>
        <option value="8" selected>8x8</option>
        <option value="10">10x10</option>
        <option value="12">12x12</option>
      </select>
    </label>
    <button onclick="resetBoard()">Reset</button>
    <button onclick="shuffleBoard()">Shuffle</button>
    <button onclick="popAll()">Pop All</button>
  </footer>

  <script>
    let size = 8;
    let bubbles = [];
    let moves = 0;
    let popped = 0;
    let startTime = null;
    let bestTime = null;

    const boardEl = document.getElementById('board');
    const statsEl = document.getElementById('stats');
    const progressEl = document.getElementById('progress');
    const bestTimeEl = document.getElementById('bestTime');

    function initBoard() {
      boardEl.style.gridTemplateColumns = `repeat(${size}, 50px)`;
      boardEl.style.gridTemplateRows = `repeat(${size}, 50px)`;
      bubbles = [];
      boardEl.innerHTML = '';
      for (let i = 0; i < size*size; i++) {
        const div = document.createElement('div');
        div.className = 'bubble';
        div.dataset.index = i;
        div.onclick = () => toggleBubble(i);
        boardEl.appendChild(div);
        bubbles.push({popped:false, el:div});
      }
      moves = 0;
      popped = 0;
      startTime = null;
      updateUI();
    }

    function toggleBubble(i) {
      if (!startTime) startTime = Date.now();
      const b = bubbles[i];
      b.popped = !b.popped;
      b.el.classList.toggle('popped');
      popped += b.popped ? 1 : -1;
      moves++;
      playPop();
      updateUI();
      if (popped === size*size) celebrate();
    }

    function resetBoard() { initBoard(); }
    function shuffleBoard() {
      bubbles.forEach(b => {
        const state = Math.random() < 0.5;
        b.popped = state;
        b.el.classList.toggle('popped', state);
      });
      moves = 0;
      popped = bubbles.filter(b=>b.popped).length;
      startTime = Date.now();
      updateUI();
    }
    function popAll() {
      bubbles.forEach(b => { b.popped = true; b.el.classList.add('popped'); });
      popped = size*size;
      moves++;
      updateUI();
      celebrate();
    }

    function updateUI() {
      statsEl.textContent = `Moves: ${moves} | ${popped}/${size*size}`;
      progressEl.value = popped/(size*size);
      if (bestTime) bestTimeEl.textContent = `Best: ${bestTime.toFixed(2)}s`;
    }

    function celebrate() {
      if (startTime) {
        const elapsed = (Date.now() - startTime)/1000;
        if (!bestTime || elapsed < bestTime) bestTime = elapsed;
        bestTimeEl.textContent = `Best: ${bestTime.toFixed(2)}s`;
      }
      for (let i=0; i<50; i++) spawnConfetti();
    }

    function spawnConfetti() {
      const div = document.createElement('div');
      div.className = 'confetti';
      div.style.left = Math.random()*100 + 'vw';
      div.style.top = '-10px';
      div.style.backgroundColor = `hsl(${Math.random()*360},100%,50%)`;
      document.body.appendChild(div);
      setTimeout(()=>div.remove(),2000);
    }

    function playPop() {
      const ctx = new (window.AudioContext||window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'square';
      osc.frequency.value = 300;
      gain.gain.setValueAtTime(0.1, ctx.currentTime);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      osc.stop(ctx.currentTime+0.1);
    }

    document.getElementById('sizeSelect').onchange = (e)=>{
      size = parseInt(e.target.value);
      initBoard();
    };

    // PWA Service Worker 登録
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js');
      });
    }

    initBoard();
  </script>
</body>
</html>